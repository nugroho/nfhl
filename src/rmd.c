/* ------------------------------------------------------------------------
 * Copyright (c) 2010 Arif Endro Nugroho
 * 
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. The name of Arif Endro Nugroho may not be used to endorse or promote
 *    products derived from this software without specific prior written
 *    permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY ARIF ENDRO NUGROHO "AS IS" AND ANY EXPRESS
 * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL ARIF ENDRO NUGROHO BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
 * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 * 
 * End Of License.
 * ------------------------------------------------------------------------
 */

#include "rmd.h"

#define ROTL(x,n)  (unsigned long)( x << n  | x>>(32-n))
#define F1(x,y,z)  (unsigned long)( x ^  y  ^        z ) /* 0x00 <= i < 0x10 */
#define F2(x,y,z)  (unsigned long)((x &  y) | (~x &  z)) /* 0x10 <= i < 0x20 */
#define F3(x,y,z)  (unsigned long)((x | ~y) ^        z ) /* 0x20 <= i < 0x30 */
#define F4(x,y,z)  (unsigned long)((x &  z) | ( y & ~z)) /* 0x30 <= i < 0x40 */
#define F5(x,y,z)  (unsigned long)( x       ^ ( y | ~z)) /* 0x40 <= i < 0x50 */

void rmd160(const unsigned long *X, unsigned long *IH, const unsigned long init)
{
   const unsigned long H[0x05] = {
      0x67452301UL,
      0xefcdab89UL,
      0x98badcfeUL,
      0x10325476UL,
      0xc3d2e1f0UL
   };
   const unsigned long KL[0x05] = {
      0x00000000UL,
      0x5a827999UL,
      0x6ed9eba1UL,
      0x8f1bbcdcUL,
      0xa953fd4eUL
   };
   const unsigned long KR[0x05] = {
      0x50a28be6UL,
      0x5c4dd124UL,
      0x6d703ef3UL,
      0x7a6d76e9UL,
      0x00000000UL
   };  

   unsigned long AL          = 0x00000000UL;
   unsigned long BL          = 0x00000000UL;
   unsigned long CL          = 0x00000000UL;
   unsigned long DL          = 0x00000000UL;
   unsigned long EL          = 0x00000000UL;
   unsigned long AR          = 0x00000000UL;
   unsigned long BR          = 0x00000000UL;
   unsigned long CR          = 0x00000000UL;
   unsigned long DR          = 0x00000000UL;
   unsigned long ER          = 0x00000000UL;

   unsigned long k           = 0x00000000UL;
   unsigned long s           = 0x00000000UL;
   unsigned long i           = 0x00000000UL;

   unsigned long T           = 0x00000000UL;

   const unsigned int  RL[0x50] = {
   0x0, 0x1, 0x2, 0x3, 0x4, 0x5, 0x6, 0x7,
   0x8, 0x9, 0xa, 0xb, 0xc, 0xd, 0xe, 0xf,
   0x7, 0x4, 0xd, 0x1, 0xa, 0x6, 0xf, 0x3,
   0xc, 0x0, 0x9, 0x5, 0x2, 0xe, 0xb, 0x8,
   0x3, 0xa, 0xe, 0x4, 0x9, 0xf, 0x8, 0x1,
   0x2, 0x7, 0x0, 0x6, 0xd, 0xb, 0x5, 0xc,
   0x1, 0x9, 0xb, 0xa, 0x0, 0x8, 0xc, 0x4,
   0xd, 0x3, 0x7, 0xf, 0xe, 0x5, 0x6, 0x2,
   0x4, 0x0, 0x5, 0x9, 0x7, 0xc, 0x2, 0xa,
   0xe, 0x1, 0x3, 0x8, 0xb, 0x6, 0xf, 0xd
   };
   const unsigned int  RR[0x50] = {
   0x5, 0xe, 0x7, 0x0, 0x9, 0x2, 0xb, 0x4,
   0xd, 0x6, 0xf, 0x8, 0x1, 0xa, 0x3, 0xc,
   0x6, 0xb, 0x3, 0x7, 0x0, 0xd, 0x5, 0xa,
   0xe, 0xf, 0x8, 0xc, 0x4, 0x9, 0x1, 0x2,
   0xf, 0x5, 0x1, 0x3, 0x7, 0xe, 0x6, 0x9,
   0xb, 0x8, 0xc, 0x2, 0xa, 0x0, 0x4, 0xd,
   0x8, 0x6, 0x4, 0x1, 0x3, 0xb, 0xf, 0x0,
   0x5, 0xc, 0x2, 0xd, 0x9, 0x7, 0xa, 0xe,
   0xc, 0xf, 0xa, 0x4, 0x1, 0x5, 0x8, 0x7,
   0x6, 0x2, 0xd, 0xe, 0x0, 0x3, 0x9, 0xb
   };
   const unsigned int  SL[0x50] = {
   0xb, 0xe, 0xf, 0xc, 0x5, 0x8, 0x7, 0x9,
   0xb, 0xd, 0xe, 0xf, 0x6, 0x7, 0x9, 0x8,
   0x7, 0x6, 0x8, 0xd, 0xb, 0x9, 0x7, 0xf,
   0x7, 0xc, 0xf, 0x9, 0xb, 0x7, 0xd, 0xc,
   0xb, 0xd, 0x6, 0x7, 0xe, 0x9, 0xd, 0xf,
   0xe, 0x8, 0xd, 0x6, 0x5, 0xc, 0x7, 0x5,
   0xb, 0xc, 0xe, 0xf, 0xe, 0xf, 0x9, 0x8,
   0x9, 0xe, 0x5, 0x6, 0x8, 0x6, 0x5, 0xc,
   0x9, 0xf, 0x5, 0xb, 0x6, 0x8, 0xd, 0xc,
   0x5, 0xc, 0xd, 0xe, 0xb, 0x8, 0x5, 0x6
   };
   const unsigned int  SR[0x50] = {
   0x8, 0x9, 0x9, 0xb, 0xd, 0xf, 0xf, 0x5,
   0x7, 0x7, 0x8, 0xb, 0xe, 0xe, 0xc, 0x6,
   0x9, 0xd, 0xf, 0x7, 0xc, 0x8, 0x9, 0xb,
   0x7, 0x7, 0xc, 0x7, 0x6, 0xf, 0xd, 0xb,
   0x9, 0x7, 0xf, 0xb, 0x8, 0x6, 0x6, 0xe,
   0xc, 0xd, 0x5, 0xe, 0xd, 0xd, 0x7, 0x5,
   0xf, 0x5, 0x8, 0xb, 0xe, 0xe, 0x6, 0xe,
   0x6, 0x9, 0xc, 0x9, 0xc, 0x5, 0xf, 0x8,
   0x8, 0x5, 0xc, 0x9, 0xc, 0x5, 0xe, 0x6,
   0x8, 0xd, 0x6, 0x5, 0xf, 0xd, 0xb, 0xb
   };

   if(init) {
      AL =  H[0x0];
      BL =  H[0x1];
      CL =  H[0x2];
      DL =  H[0x3];
      EL =  H[0x4];
      AR =  H[0x0];
      BR =  H[0x1];
      CR =  H[0x2];
      DR =  H[0x3];
      ER =  H[0x4];
   } else {
      AL = IH[0x0];
      BL = IH[0x1];
      CL = IH[0x2];
      DL = IH[0x3];
      EL = IH[0x4];
      AR = IH[0x0];
      BR = IH[0x1];
      CR = IH[0x2];
      DR = IH[0x3];
      ER = IH[0x4];
   }

   for (i=0; i< 0x50; i++) {
      if        (i < 0x10) {
         k  = RL[i]; 
         s  = SL[i]; 
         T  = ROTL((AL + F1(BL,CL,DL) + X[k] + KL[0x0]), s) + EL;
         AL = EL;
         EL = DL;
         DL = ROTL(CL, 10);
         CL = BL;
         BL = T ;
         k  = RR[i];
         s  = SR[i];
         T  = ROTL((AR + F5(BR,CR,DR) + X[k] + KR[0x0]), s) + ER;
         AR = ER;
         ER = DR;
         DR = ROTL(CR, 10);
         CR = BR;
         BR = T ;
      } else if (i < 0x20) {
         k  = RL[i]; 
         s  = SL[i]; 
         T  = ROTL((AL + F2(BL,CL,DL) + X[k] + KL[0x1]), s) + EL;
         AL = EL;
         EL = DL;
         DL = ROTL(CL, 10);
         CL = BL;
         BL = T ;
         k  = RR[i];
         s  = SR[i];
         T  = ROTL((AR + F4(BR,CR,DR) + X[k] + KR[0x1]), s) + ER;
         AR = ER;
         ER = DR;
         DR = ROTL(CR, 10);
         CR = BR;
         BR = T ;
      } else if (i < 0x30) {
         k  = RL[i]; 
         s  = SL[i]; 
         T  = ROTL((AL + F3(BL,CL,DL) + X[k] + KL[0x2]), s) + EL;
         AL = EL;
         EL = DL;
         DL = ROTL(CL, 10);
         CL = BL;
         BL = T ;
         k  = RR[i];
         s  = SR[i];
         T  = ROTL((AR + F3(BR,CR,DR) + X[k] + KR[0x2]), s) + ER;
         AR = ER;
         ER = DR;
         DR = ROTL(CR, 10);
         CR = BR;
         BR = T ;
      } else if (i < 0x40) {
         k  = RL[i]; 
         s  = SL[i]; 
         T  = ROTL((AL + F4(BL,CL,DL) + X[k] + KL[0x3]), s) + EL;
         AL = EL;
         EL = DL;
         DL = ROTL(CL, 10);
         CL = BL;
         BL = T ;
         k  = RR[i];
         s  = SR[i];
         T  = ROTL((AR + F2(BR,CR,DR) + X[k] + KR[0x3]), s) + ER;
         AR = ER;
         ER = DR;
         DR = ROTL(CR, 10);
         CR = BR;
         BR = T ;
      } else if (i < 0x50) {
         k  = RL[i]; 
         s  = SL[i]; 
         T  = ROTL((AL + F5(BL,CL,DL) + X[k] + KL[0x4]), s) + EL;
         AL = EL;
         EL = DL;
         DL = ROTL(CL, 10);
         CL = BL;
         BL = T ;
         k  = RR[i];
         s  = SR[i];
         T  = ROTL((AR + F1(BR,CR,DR) + X[k] + KR[0x4]), s) + ER;
         AR = ER;
         ER = DR;
         DR = ROTL(CR, 10);
         CR = BR;
         BR = T ;
      }
   }

   if(init) {
      T       =  H[0x1] + CL + DR;
      IH[0x1] =  H[0x2] + DL + ER;
      IH[0x2] =  H[0x3] + EL + AR;
      IH[0x3] =  H[0x4] + AL + BR;
      IH[0x4] =  H[0x0] + BL + CR;
      IH[0x0] =  T ;
   } else {
      T       = IH[0x1] + CL + DR;
      IH[0x1] = IH[0x2] + DL + ER;
      IH[0x2] = IH[0x3] + EL + AR;
      IH[0x3] = IH[0x4] + AL + BR;
      IH[0x4] = IH[0x0] + BL + CR;
      IH[0x0] = T ;
   }

}

void rmd128(const unsigned long *X, unsigned long *IH, const unsigned long init)
{
   const unsigned long H[0x04] = {
      0x67452301UL,
      0xefcdab89UL,
      0x98badcfeUL,
      0x10325476UL
   };
   const unsigned long KL[0x04] = {
      0x00000000UL,
      0x5a827999UL,
      0x6ed9eba1UL,
      0x8f1bbcdcUL
   };
   const unsigned long KR[0x04] = {
      0x50a28be6UL,
      0x5c4dd124UL,
      0x6d703ef3UL,
      0x00000000UL
   };  

   unsigned long AL          = 0x00000000UL;
   unsigned long BL          = 0x00000000UL;
   unsigned long CL          = 0x00000000UL;
   unsigned long DL          = 0x00000000UL;
   unsigned long AR          = 0x00000000UL;
   unsigned long BR          = 0x00000000UL;
   unsigned long CR          = 0x00000000UL;
   unsigned long DR          = 0x00000000UL;

   unsigned long k           = 0x00000000UL;
   unsigned long s           = 0x00000000UL;
   unsigned long i           = 0x00000000UL;

   unsigned long T           = 0x00000000UL;

   const unsigned int  RL[0x40] = {
   0x0, 0x1, 0x2, 0x3, 0x4, 0x5, 0x6, 0x7,
   0x8, 0x9, 0xa, 0xb, 0xc, 0xd, 0xe, 0xf,
   0x7, 0x4, 0xd, 0x1, 0xa, 0x6, 0xf, 0x3,
   0xc, 0x0, 0x9, 0x5, 0x2, 0xe, 0xb, 0x8,
   0x3, 0xa, 0xe, 0x4, 0x9, 0xf, 0x8, 0x1,
   0x2, 0x7, 0x0, 0x6, 0xd, 0xb, 0x5, 0xc,
   0x1, 0x9, 0xb, 0xa, 0x0, 0x8, 0xc, 0x4,
   0xd, 0x3, 0x7, 0xf, 0xe, 0x5, 0x6, 0x2
   };
   const unsigned int  RR[0x40] = {
   0x5, 0xe, 0x7, 0x0, 0x9, 0x2, 0xb, 0x4,
   0xd, 0x6, 0xf, 0x8, 0x1, 0xa, 0x3, 0xc,
   0x6, 0xb, 0x3, 0x7, 0x0, 0xd, 0x5, 0xa,
   0xe, 0xf, 0x8, 0xc, 0x4, 0x9, 0x1, 0x2,
   0xf, 0x5, 0x1, 0x3, 0x7, 0xe, 0x6, 0x9,
   0xb, 0x8, 0xc, 0x2, 0xa, 0x0, 0x4, 0xd,
   0x8, 0x6, 0x4, 0x1, 0x3, 0xb, 0xf, 0x0,
   0x5, 0xc, 0x2, 0xd, 0x9, 0x7, 0xa, 0xe
   };
   const unsigned int  SL[0x40] = {
   0xb, 0xe, 0xf, 0xc, 0x5, 0x8, 0x7, 0x9,
   0xb, 0xd, 0xe, 0xf, 0x6, 0x7, 0x9, 0x8,
   0x7, 0x6, 0x8, 0xd, 0xb, 0x9, 0x7, 0xf,
   0x7, 0xc, 0xf, 0x9, 0xb, 0x7, 0xd, 0xc,
   0xb, 0xd, 0x6, 0x7, 0xe, 0x9, 0xd, 0xf,
   0xe, 0x8, 0xd, 0x6, 0x5, 0xc, 0x7, 0x5,
   0xb, 0xc, 0xe, 0xf, 0xe, 0xf, 0x9, 0x8,
   0x9, 0xe, 0x5, 0x6, 0x8, 0x6, 0x5, 0xc
   };
   const unsigned int  SR[0x40] = {
   0x8, 0x9, 0x9, 0xb, 0xd, 0xf, 0xf, 0x5,
   0x7, 0x7, 0x8, 0xb, 0xe, 0xe, 0xc, 0x6,
   0x9, 0xd, 0xf, 0x7, 0xc, 0x8, 0x9, 0xb,
   0x7, 0x7, 0xc, 0x7, 0x6, 0xf, 0xd, 0xb,
   0x9, 0x7, 0xf, 0xb, 0x8, 0x6, 0x6, 0xe,
   0xc, 0xd, 0x5, 0xe, 0xd, 0xd, 0x7, 0x5,
   0xf, 0x5, 0x8, 0xb, 0xe, 0xe, 0x6, 0xe,
   0x6, 0x9, 0xc, 0x9, 0xc, 0x5, 0xf, 0x8
   };

   if(init) {
      AL =  H[0x0];
      BL =  H[0x1];
      CL =  H[0x2];
      DL =  H[0x3];
      AR =  H[0x0];
      BR =  H[0x1];
      CR =  H[0x2];
      DR =  H[0x3];
   } else {
      AL = IH[0x0];
      BL = IH[0x1];
      CL = IH[0x2];
      DL = IH[0x3];
      AR = IH[0x0];
      BR = IH[0x1];
      CR = IH[0x2];
      DR = IH[0x3];
   }

   for (i=0; i< 0x40; i++) {
      if        (i < 0x10) {
         k  = RL[i]; 
         s  = SL[i]; 
         T  = ROTL((AL + F1(BL,CL,DL) + X[k] + KL[0x0]), s);
         AL = DL;
         DL = CL;
         CL = BL;
         BL = T ;
         k  = RR[i];
         s  = SR[i];
         T  = ROTL((AR + F4(BR,CR,DR) + X[k] + KR[0x0]), s);
         AR = DR;
         DR = CR;
         CR = BR;
         BR = T ;
      } else if (i < 0x20) {
         k  = RL[i]; 
         s  = SL[i]; 
         T  = ROTL((AL + F2(BL,CL,DL) + X[k] + KL[0x1]), s);
         AL = DL;
         DL = CL;
         CL = BL;
         BL = T ;
         k  = RR[i];
         s  = SR[i];
         T  = ROTL((AR + F3(BR,CR,DR) + X[k] + KR[0x1]), s);
         AR = DR;
         DR = CR;
         CR = BR;
         BR = T ;
      } else if (i < 0x30) {
         k  = RL[i]; 
         s  = SL[i]; 
         T  = ROTL((AL + F3(BL,CL,DL) + X[k] + KL[0x2]), s);
         AL = DL;
         DL = CL;
         CL = BL;
         BL = T ;
         k  = RR[i];
         s  = SR[i];
         T  = ROTL((AR + F2(BR,CR,DR) + X[k] + KR[0x2]), s);
         AR = DR;
         DR = CR;
         CR = BR;
         BR = T ;
      } else if (i < 0x40) {
         k  = RL[i]; 
         s  = SL[i]; 
         T  = ROTL((AL + F4(BL,CL,DL) + X[k] + KL[0x3]), s);
         AL = DL;
         DL = CL;
         CL = BL;
         BL = T ;
         k  = RR[i];
         s  = SR[i];
         T  = ROTL((AR + F1(BR,CR,DR) + X[k] + KR[0x3]), s);
         AR = DR;
         DR = CR;
         CR = BR;
         BR = T ;
      }
   }

   if(init) {
      T       =  H[0x1] + CL + DR;
      IH[0x1] =  H[0x2] + DL + AR;
      IH[0x2] =  H[0x3] + AL + BR;
      IH[0x3] =  H[0x0] + BL + CR;
      IH[0x0] =  T ;
   } else {
      T       = IH[0x1] + CL + DR;
      IH[0x1] = IH[0x2] + DL + AR;
      IH[0x2] = IH[0x3] + AL + BR;
      IH[0x3] = IH[0x0] + BL + CR;
      IH[0x0] = T ;
   }

}

void rmd256(const unsigned long *X, unsigned long *IH, const unsigned long init)
{
   const unsigned long H[0x08] = {
      0x67452301UL,
      0xefcdab89UL,
      0x98badcfeUL,
      0x10325476UL,
      0x76543210UL,
      0xfedcba98UL,
      0x89abcdefUL,
      0x01234567UL
   };
   const unsigned long KL[0x04] = {
      0x00000000UL,
      0x5a827999UL,
      0x6ed9eba1UL,
      0x8f1bbcdcUL
   };
   const unsigned long KR[0x04] = {
      0x50a28be6UL,
      0x5c4dd124UL,
      0x6d703ef3UL,
      0x00000000UL
   };  

   unsigned long AL          = 0x00000000UL;
   unsigned long BL          = 0x00000000UL;
   unsigned long CL          = 0x00000000UL;
   unsigned long DL          = 0x00000000UL;
   unsigned long AR          = 0x00000000UL;
   unsigned long BR          = 0x00000000UL;
   unsigned long CR          = 0x00000000UL;
   unsigned long DR          = 0x00000000UL;

   unsigned long k           = 0x00000000UL;
   unsigned long s           = 0x00000000UL;
   unsigned long i           = 0x00000000UL;

   unsigned long T           = 0x00000000UL;

   const unsigned int  RL[0x40] = {
   0x0, 0x1, 0x2, 0x3, 0x4, 0x5, 0x6, 0x7,
   0x8, 0x9, 0xa, 0xb, 0xc, 0xd, 0xe, 0xf,
   0x7, 0x4, 0xd, 0x1, 0xa, 0x6, 0xf, 0x3,
   0xc, 0x0, 0x9, 0x5, 0x2, 0xe, 0xb, 0x8,
   0x3, 0xa, 0xe, 0x4, 0x9, 0xf, 0x8, 0x1,
   0x2, 0x7, 0x0, 0x6, 0xd, 0xb, 0x5, 0xc,
   0x1, 0x9, 0xb, 0xa, 0x0, 0x8, 0xc, 0x4,
   0xd, 0x3, 0x7, 0xf, 0xe, 0x5, 0x6, 0x2
   };
   const unsigned int  RR[0x40] = {
   0x5, 0xe, 0x7, 0x0, 0x9, 0x2, 0xb, 0x4,
   0xd, 0x6, 0xf, 0x8, 0x1, 0xa, 0x3, 0xc,
   0x6, 0xb, 0x3, 0x7, 0x0, 0xd, 0x5, 0xa,
   0xe, 0xf, 0x8, 0xc, 0x4, 0x9, 0x1, 0x2,
   0xf, 0x5, 0x1, 0x3, 0x7, 0xe, 0x6, 0x9,
   0xb, 0x8, 0xc, 0x2, 0xa, 0x0, 0x4, 0xd,
   0x8, 0x6, 0x4, 0x1, 0x3, 0xb, 0xf, 0x0,
   0x5, 0xc, 0x2, 0xd, 0x9, 0x7, 0xa, 0xe
   };
   const unsigned int  SL[0x40] = {
   0xb, 0xe, 0xf, 0xc, 0x5, 0x8, 0x7, 0x9,
   0xb, 0xd, 0xe, 0xf, 0x6, 0x7, 0x9, 0x8,
   0x7, 0x6, 0x8, 0xd, 0xb, 0x9, 0x7, 0xf,
   0x7, 0xc, 0xf, 0x9, 0xb, 0x7, 0xd, 0xc,
   0xb, 0xd, 0x6, 0x7, 0xe, 0x9, 0xd, 0xf,
   0xe, 0x8, 0xd, 0x6, 0x5, 0xc, 0x7, 0x5,
   0xb, 0xc, 0xe, 0xf, 0xe, 0xf, 0x9, 0x8,
   0x9, 0xe, 0x5, 0x6, 0x8, 0x6, 0x5, 0xc
   };
   const unsigned int  SR[0x40] = {
   0x8, 0x9, 0x9, 0xb, 0xd, 0xf, 0xf, 0x5,
   0x7, 0x7, 0x8, 0xb, 0xe, 0xe, 0xc, 0x6,
   0x9, 0xd, 0xf, 0x7, 0xc, 0x8, 0x9, 0xb,
   0x7, 0x7, 0xc, 0x7, 0x6, 0xf, 0xd, 0xb,
   0x9, 0x7, 0xf, 0xb, 0x8, 0x6, 0x6, 0xe,
   0xc, 0xd, 0x5, 0xe, 0xd, 0xd, 0x7, 0x5,
   0xf, 0x5, 0x8, 0xb, 0xe, 0xe, 0x6, 0xe,
   0x6, 0x9, 0xc, 0x9, 0xc, 0x5, 0xf, 0x8
   };

   if(init) {
      AL =  H[0x0];
      BL =  H[0x1];
      CL =  H[0x2];
      DL =  H[0x3];
      AR =  H[0x4];
      BR =  H[0x5];
      CR =  H[0x6];
      DR =  H[0x7];
   } else {
      AL = IH[0x0];
      BL = IH[0x1];
      CL = IH[0x2];
      DL = IH[0x3];
      AR = IH[0x4];
      BR = IH[0x5];
      CR = IH[0x6];
      DR = IH[0x7];
   }

   for (i=0; i< 0x40; i++) {
      if        (i < 0x10) {
         k  = RL[i]; 
         s  = SL[i]; 
         T  = ROTL((AL + F1(BL,CL,DL) + X[k] + KL[0x0]), s);
         AL = DL;
         DL = CL;
         CL = BL;
         BL = T ;
         k  = RR[i];
         s  = SR[i];
         T  = ROTL((AR + F4(BR,CR,DR) + X[k] + KR[0x0]), s);
         AR = DR;
         DR = CR;
         CR = BR;
         BR = T ;
      } else if (i < 0x20) {
         k  = RL[i]; 
         s  = SL[i]; 
         T  = ROTL((AL + F2(BL,CL,DL) + X[k] + KL[0x1]), s);
         AL = DL;
         DL = CL;
         CL = BL;
         BL = T ;
         k  = RR[i];
         s  = SR[i];
         T  = ROTL((AR + F3(BR,CR,DR) + X[k] + KR[0x1]), s);
         AR = DR;
         DR = CR;
         CR = BR;
         BR = T ;
      } else if (i < 0x30) {
         k  = RL[i]; 
         s  = SL[i]; 
         T  = ROTL((AL + F3(BL,CL,DL) + X[k] + KL[0x2]), s);
         AL = DL;
         DL = CL;
         CL = BL;
         BL = T ;
         k  = RR[i];
         s  = SR[i];
         T  = ROTL((AR + F2(BR,CR,DR) + X[k] + KR[0x2]), s);
         AR = DR;
         DR = CR;
         CR = BR;
         BR = T ;
      } else if (i < 0x40) {
         k  = RL[i]; 
         s  = SL[i]; 
         T  = ROTL((AL + F4(BL,CL,DL) + X[k] + KL[0x3]), s);
         AL = DL;
         DL = CL;
         CL = BL;
         BL = T ;
         k  = RR[i];
         s  = SR[i];
         T  = ROTL((AR + F1(BR,CR,DR) + X[k] + KR[0x3]), s);
         AR = DR;
         DR = CR;
         CR = BR;
         BR = T ;
      }
      if      (i == 0x0f) { T = AL; AL = AR; AR = T; }
      else if (i == 0x1f) { T = BL; BL = BR; BR = T; }
      else if (i == 0x2f) { T = CL; CL = CR; CR = T; }
      else if (i == 0x3f) { T = DL; DL = DR; DR = T; }
   }

   if(init) {
      IH[0x0] =  H[0x0] + AL;
      IH[0x1] =  H[0x1] + BL;
      IH[0x2] =  H[0x2] + CL;
      IH[0x3] =  H[0x3] + DL;
      IH[0x4] =  H[0x4] + AR;
      IH[0x5] =  H[0x5] + BR;
      IH[0x6] =  H[0x6] + CR;
      IH[0x7] =  H[0x7] + DR;
   } else {
      IH[0x0] = IH[0x0] + AL;
      IH[0x1] = IH[0x1] + BL;
      IH[0x2] = IH[0x2] + CL;
      IH[0x3] = IH[0x3] + DL;
      IH[0x4] = IH[0x4] + AR;
      IH[0x5] = IH[0x5] + BR;
      IH[0x6] = IH[0x6] + CR;
      IH[0x7] = IH[0x7] + DR;
   }

}
